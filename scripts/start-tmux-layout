#!/usr/bin/env bash
set -euo pipefail

# Default session name to the basename of the current workdir if not provided
if [ -z "${TMUX_SESSION:-}" ]; then
  TMUX_SESSION="$(basename "${PWD}" 2>/dev/null || echo workspace)"
fi

# Sanitize the tmux session name to avoid special characters breaking tmux
# Replace any non-alphanumeric with '_', trim/collapse '_', ensure non-empty, and limit length to 32
_sanitize_tmux_name() {
  # Use POSIX sed to transform the name
  # 1) Replace any run of non-alphanumeric characters with '_'
  # 2) Trim leading/trailing '_'
  # 3) Collapse multiple '_' to single
  # 4) Ensure non-empty; fallback to "workspace"
  # 5) Truncate to 32 chars (tmux-friendly)
  local input
  input="$1"
  # Replace non-alphanumeric chars with '_'
  input="$(printf '%s' "$input" | sed -E 's/[^A-Za-z0-9]+/_/g')"
  # Trim leading/trailing '_'
  input="$(printf '%s' "$input" | sed -E 's/^_+//; s/_+$//')"
  # Collapse multiple '_'
  input="$(printf '%s' "$input" | sed -E 's/_{2,}/_/g')"
  # Fallback if empty
  if [ -z "$input" ]; then
    input="workspace"
  fi
  # Truncate to 32 characters
  printf '%.32s' "$input"
}

TMUX_SESSION="$(_sanitize_tmux_name "$TMUX_SESSION")"

export TERM="${TERM:-xterm-256color}"
export LANG="${LANG:-C.UTF-8}"
export TMUX_TMPDIR="${TMUX_TMPDIR:-/tmp}"

# Allow longer session name in tmux status bar (status-left)
STATUS_LEFT_LENGTH="${TMUX_STATUS_LEFT_LENGTH:-32}"
STATUS_RIGHT_LENGTH="${TMUX_STATUS_RIGHT_LENGTH:-64}"
# Status-left content: show session name in yellow; most text uses default light gray
TMUX_STATUS_LEFT="${TMUX_STATUS_LEFT:-#[fg=yellow] #S #[fg=default]}"
# Status-right content: show time and date
TMUX_STATUS_RIGHT="${TMUX_STATUS_RIGHT:-#[fg=default] %Y-%m-%d %H:%M #[fg=yellow]#H }"

# Style the tmux status line so the active tab/window is brighter
# You can override these via environment variables if desired.
TMUX_STATUS_STYLE="${TMUX_STATUS_STYLE:-bg=colour22,fg=colour250}"
TMUX_WINDOW_STATUS_STYLE="${TMUX_WINDOW_STATUS_STYLE:-bg=colour22,fg=colour250}"
TMUX_WINDOW_STATUS_CURRENT_STYLE="${TMUX_WINDOW_STATUS_CURRENT_STYLE:-bg=colour22,fg=colour120,bold}"
# Ensure activity/bell styles don't override current style perception
TMUX_WINDOW_STATUS_ACTIVITY_STYLE="${TMUX_WINDOW_STATUS_ACTIVITY_STYLE:-bg=colour22,fg=colour250}"
TMUX_WINDOW_STATUS_BELL_STYLE="${TMUX_WINDOW_STATUS_BELL_STYLE:-bg=colour22,fg=colour250,bold}"
# Use neutral formats with no inline colors so style options fully control colors
TMUX_WINDOW_STATUS_FORMAT="${TMUX_WINDOW_STATUS_FORMAT:-#I: #W#{?window_flags,#{window_flags}, }}"
TMUX_WINDOW_STATUS_CURRENT_FORMAT="${TMUX_WINDOW_STATUS_CURRENT_FORMAT:-#I: #W#{?window_flags,#{window_flags}, }}"

# Create the session if it does not exist
if ! tmux has-session -t "${TMUX_SESSION}" 2>/dev/null; then
  # First tab: main AI CLI (kept alive with exec bash -l)
  AI_NAME="${AI_NAME:-codex}"
  AI_COMMAND="${AI_COMMAND:-codex}"
  tmux new-session -d -s "${TMUX_SESSION}" -n "${AI_NAME}" \
    "/bin/bash" -lc "${AI_COMMAND} || true; exec bash -l" || {
      echo "[start-tmux-layout] Failed to create tmux session: ${TMUX_SESSION}" >&2
      exec /bin/bash -l
    }
  # Second tab: shell
  tmux new-window  -t "${TMUX_SESSION}:" -n shell "/bin/bash -l" || true
  # Third tab: shell
  tmux new-window  -t "${TMUX_SESSION}:" -n shell "/bin/bash -l" || true
  # Fourth tab: htop
  tmux new-window  -t "${TMUX_SESSION}:" -n htop  "htop" || true
  # Make Codex window active by default (select by name to avoid index issues)
  # (Selection will be done below after configuration.)
fi

# After ensuring a session exists, set up a single kill-all binding
(tmux unbind-key Q >/dev/null 2>&1 || true)
(tmux bind-key Q confirm-before -p "Kill ALL tmux sessions and exit container? (y/n)" kill-server >/dev/null 2>&1 || true)

# Apply configuration to the specific session (works whether it was created or pre-existing)
(tmux set-option -t "${TMUX_SESSION}" -q status-left-length "${STATUS_LEFT_LENGTH}" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q status-left "$TMUX_STATUS_LEFT" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q status-right-length "${STATUS_RIGHT_LENGTH}" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q status-right "$TMUX_STATUS_RIGHT" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q status-style "$TMUX_STATUS_STYLE" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-style "$TMUX_WINDOW_STATUS_STYLE" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-current-style "$TMUX_WINDOW_STATUS_CURRENT_STYLE" >/dev/null 2>&1 || true)
# Also set styles globally to ensure color changes take effect if session-specific was not applied
(tmux set-option -g -q status-style "$TMUX_STATUS_STYLE" >/dev/null 2>&1 || true)
(tmux set-option -g -q window-status-style "$TMUX_WINDOW_STATUS_STYLE" >/dev/null 2>&1 || true)
(tmux set-option -g -q window-status-current-style "$TMUX_WINDOW_STATUS_CURRENT_STYLE" >/dev/null 2>&1 || true)
# Ensure formats are neutral so styles above apply
(tmux set-option -t "${TMUX_SESSION}" -q status-right-length "${STATUS_RIGHT_LENGTH}" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q status-right "$TMUX_STATUS_RIGHT" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-format "$TMUX_WINDOW_STATUS_FORMAT" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-current-format "$TMUX_WINDOW_STATUS_CURRENT_FORMAT" >/dev/null 2>&1 || true)
# Also set globally after a session exists to ensure consistent behavior
(tmux set-option -g -q status-right-length "${STATUS_RIGHT_LENGTH}" >/dev/null 2>&1 || true)
(tmux set-option -g -q status-right "$TMUX_STATUS_RIGHT" >/dev/null 2>&1 || true)
(tmux set-option -g -q window-status-format "$TMUX_WINDOW_STATUS_FORMAT" >/dev/null 2>&1 || true)
(tmux set-option -g -q window-status-current-format "$TMUX_WINDOW_STATUS_CURRENT_FORMAT" >/dev/null 2>&1 || true)
# Prevent activity/bell from changing tab color unless it is current
(tmux set-option -t "${TMUX_SESSION}" -q monitor-activity off >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q visual-activity off >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-activity-style "$TMUX_WINDOW_STATUS_ACTIVITY_STYLE" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-bell-style "$TMUX_WINDOW_STATUS_BELL_STYLE" >/dev/null 2>&1 || true)
# Legacy per-session options for older tmux versions
(tmux set-option -t "${TMUX_SESSION}" -q status-bg "default" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q status-fg "colour250" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-bg "default" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-fg "colour250" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-attr "none" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-current-bg "default" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-current-fg "colour120" >/dev/null 2>&1 || true)
(tmux set-option -t "${TMUX_SESSION}" -q window-status-current-attr "bold" >/dev/null 2>&1 || true)

# Ensure main AI CLI window is selected on attach
AI_NAME="${AI_NAME:-codex}"
(tmux select-window -t "${TMUX_SESSION}:${AI_NAME}" >/dev/null 2>&1 || true)
# Try to attach; on failure, show diagnostics and fall back to a shell
if ! exec tmux attach -t "${TMUX_SESSION}"; then
  echo "[start-tmux-layout] tmux attach failed. Diagnostics:" >&2
  tmux list-sessions 2>&1 || true
  ps -ef | grep tmux | grep -v grep || true
  echo "TERM=$TERM LANG=$LANG TMUX=${TMUX-} TMUX_TMPDIR=${TMUX_TMPDIR-}" >&2
  exec /bin/bash -l
fi
